name: Release Docker Image

# æ”¯æŒæ ‡ç­¾å‘å¸ƒ
on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'  # åŒ¹é… x.x.x æ ¼å¼çš„ç‰ˆæœ¬æ ‡ç­¾
      - 'v[0-9]+.[0-9]+.[0-9]+' # åŒ¹é… vx.x.x æ ¼å¼çš„ç‰ˆæœ¬æ ‡ç­¾

env:
  REGISTRY: docker.io
  IMAGE_NAME: zsio/claude-code-hub

jobs:
  # éªŒè¯æ ‡ç­¾æ˜¯å¦åœ¨ main åˆ†æ”¯ä¸Šï¼ˆä»…æ ‡ç­¾è§¦å‘æ—¶è¿è¡Œï¼‰
  verify-branch:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    outputs:
      is_main: ${{ steps.check.outputs.is_main }}

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•ä»¥æ£€æŸ¥åˆ†æ”¯

    - name: ğŸ” Check if tag is on main branch
      id: check
      run: |
        # è·å–åŒ…å«æ­¤æ ‡ç­¾çš„åˆ†æ”¯
        BRANCHES=$(git branch -r --contains ${{ github.ref_name }} | grep -E '^\s*origin/main$' || true)

        if [ -n "$BRANCHES" ]; then
          echo "âœ… Tag ${{ github.ref_name }} is on main branch"
          echo "is_main=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Tag ${{ github.ref_name }} is NOT on main branch"
          echo "is_main=false" >> $GITHUB_OUTPUT
          exit 1
        fi

  # æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
  build-and-push:
    # ä»…å½“æ ‡ç­¾éªŒè¯é€šè¿‡æ—¶æ‰§è¡Œ
    needs: [verify-branch]
    if: needs.verify-branch.outputs.is_main == 'true'
    runs-on: ubuntu-latest
    name: Build and Push to DockerHub

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: ğŸ“‹ Extract metadata
      id: meta-tag
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        # æ ‡ç­¾ç­–ç•¥
        tags: |
          # è¯­ä¹‰åŒ–ç‰ˆæœ¬
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          # latest æ ‡ç­¾ï¼ˆå½“æ¨é€è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾æ—¶ï¼‰
          type=raw,value=latest
        # æ ‡ç­¾é£æ ¼ï¼šå»é™¤ v å‰ç¼€
        flavor: |
          latest=false
          prefix=
          suffix=

    - name: ğŸ—ï¸ Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./deploy/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta-tag.outputs.tags }}
        labels: ${{ steps.meta-tag.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        # æ·»åŠ æ„å»ºå‚æ•°
        build-args: |
          VERSION=${{ github.ref_name }}
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          VCS_REF=${{ github.sha }}

    - name: ğŸ“¦ Image pushed successfully
      run: |
        echo "âœ… Docker image pushed to DockerHub successfully!"
        echo "ğŸ“‹ Image digest: ${{ steps.build.outputs.digest }}"
        echo "ğŸ·ï¸ Image tags:"
        echo "${{ steps.meta-tag.outputs.tags }}"
        echo ""
        echo "ğŸ“ Pull commands:"
        echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}"

    - name: ğŸ‰ Create Release Notes
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          ## ğŸš€ Docker Image Released

          **Version:** ${{ github.ref_name }}
          **Image:** `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}`

          ### ğŸ“¦ Available Tags
          - `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}`
          - `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest`

          ### ğŸ³ Pull Command
          ```bash
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          ```

          ### ğŸ“ Changelog
          View commits: https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}
        draft: false
        prerelease: false
